$(window).load(function () {
    setTimeout(function () {
        $('.header,.sec').animate({ opacity: 1 }, 500);
        $('#loader').fadeOut(250);
    }, 1000);

    // Cache header height and scroll variables
    var headerHeight = $('.header').height();
    var lastScrollTop = 0;
    var scrollThreshold = 135;
    var isHeaderVisible = true;

    // Single scroll handler for header behavior
    function handleScroll() {
        var currentScrollTop = $(window).scrollTop();

        // Handle header visibility
        if (currentScrollTop > lastScrollTop && currentScrollTop > scrollThreshold) {
            if (isHeaderVisible && !$('#btn_gnav').hasClass('active')) {
                $('.header')
                    .removeClass('show')
                    .addClass('scroll')
                    .css('transform', 'translateY(-' + headerHeight + 'px)');
                isHeaderVisible = false;
            }
        } else {
            if (!isHeaderVisible || currentScrollTop <= scrollThreshold) {
                $('.header').addClass('show').css('transform', 'translateY(0)');
                isHeaderVisible = true;
                if (currentScrollTop <= scrollThreshold) {
                    $('.header').removeClass('scroll');
                }
            }
        }

        // Update classes
        if (currentScrollTop > scrollThreshold) {
            $('body').addClass('scroll');
        } else {
            $('body').removeClass('scroll');
        }

        $('#btn_gnav').toggleClass('black', $('.header').hasClass('scroll') && !$('.header').hasClass('show'));
        lastScrollTop = currentScrollTop;
    }

    // Throttled scroll event
    var scrollTimeout;
    $(window).on('scroll', function () {
        if (!scrollTimeout) {
            scrollTimeout = setTimeout(function () {
                handleScroll();
                scrollTimeout = null;
            }, 10);
        }
    });

    // Navigation button handlers
    $('#btn_gnav').on('click', function () {
        $(this).toggleClass('active');
        $('#wrap_gnav').fadeToggle(300);
    });

    $('.link_scroll').on('click', function () {
        if ($('#btn_gnav').hasClass('active')) {
            $('#btn_gnav').toggleClass('active');
            $('#wrap_gnav').fadeToggle(300);
        }
    });

    // Initialize Scrollify with modified settings
    $.scrollify({
        section: '.sec',
        interstitialSection: '.sec_menu',
        easing: 'easeOutExpo',
        scrollSpeed: 1000,
        offset: 0,
        scrollbars: false,
        standardScrollElements: '.sec_menulist',
        setHeights: true,
        overflowScroll: true,
        updateHash: false,
        touchScroll: false,
        before: function (index, sections) {
            var ref = sections[index].attr('data-section-name');
            handleScroll();
        },
    });

    // Handle scroll links
    $('.link_scroll').on('click', function () {
        $.scrollify.move($(this).attr('href'));
    });

    // Initialize sliders
    $('.sec_home .wrap_bg, .sec_shopinfo .wrap_bg').slick({
        dots: false,
        arrows: false,
        slidesToShow: 1,
        autoplay: true,
        autoplaySpeed: 3000,
        speed: 1500,
        fade: true,
        pauseOnHover: false,
    });

    // Match heights for menu items
    $('.sec_menulist .bottom .tab_cont ul li').matchHeight();

    // Menu tab handlers
    function handleMenuTab(index) {
        $('.sec_menulist .tab_cont').hide().eq(index).fadeIn(500);
        $('.sec_menulist .tab_nav01, .sec_menulist .tab_nav02').removeClass('active').eq(index).addClass('active');
    }

    $('.sec_menu .tab_nav, .sec_menulist .tab_nav01, .sec_menulist .tab_nav02').click(function () {
        var index = $(this).index();
        handleMenuTab(index);
    });

    // Section activation handler
    $(function () {
        var offset = 135;
        var sectionTops = [];
        var currentSection = -1;

        function updateSections() {
            sectionTops = [];
            $('.sec').each(function (i) {
                sectionTops[i] = $(this).offset().top;
            });
        }

        function activateSection(index) {
            if (index !== currentSection) {
                currentSection = index;
                $('.sec').removeClass('active').eq(index).addClass('active');
            }
        }

        updateSections();
        $(window).on('resize', updateSections);
        activateSection(0);

        $(window).on('scroll', function () {
            var scrollPosition = $(window).scrollTop();
            for (var i = sectionTops.length - 1; i >= 0; i--) {
                if (scrollPosition > sectionTops[i] - offset) {
                    activateSection(i);
                    break;
                }
            }
        });
    });
});
